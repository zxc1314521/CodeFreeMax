import{w as ce,W as E,ad as W,D as de,E as u,F as le,S as $,T as G,O as ue,R as M,H as _e,I as pe,o as S,G as w,J as me,K as ve,V as fe,X as Ae,P as Se,a1 as we,a4 as be}from"./debounce-BNOmQ76Y.js";import{b as I,A as T,s as C,c as R,a as _,R as P}from"./index-Dqp5W2S2.js";import{a as B,E as z,S as ye}from"./message-broker-DUQuEFlt.js";import{e as m,E as Ce,f as y,h as Ee,j as X,k as Ie,l as j,r as V,m as Re,b as Oe,a as xe,o as Me}from"./extension-client-context-CN64fWtK.js";import{S as O,i as Te,a as Pe,R as Fe}from"./remote-agents-client-DkZKHKJj.js";import"./IconButtonAugment-DO0xxfgT.js";import{I as Le}from"./Icon-CohttyM7.js";import{S as De}from"./SuccessfulButton-BTRD1tJd.js";try{A=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},(N=new A.Error().stack)&&(A._sentryDebugIds=A._sentryDebugIds||{},A._sentryDebugIds[N]="85397f6a-75aa-47ad-a10d-180bd2bb8623",A._sentryDebugIdIdentifier="sentry-dbid-85397f6a-75aa-47ad-a10d-180bd2bb8623")}catch{}var A,N;function ke(d,e){if(d.length===0)return e;if(e.length===0)return d;const t=[];let s=0,n=0;for(;s<d.length&&n<e.length;){const r=d[s].sequence_id,i=e[n].sequence_id;i!==void 0?r!==void 0?r<i?(t.push(d[s]),s++):r>i?(t.push(e[n]),n++):(t.push(e[n]),s++,n++):(console.warn("Existing history has an exchange with an undefined sequence ID"),s++):(console.warn("New history has an exchange with an undefined sequence ID"),n++)}for(;s<d.length;)t.push(d[s]),s++;for(;n<e.length;)t.push(e[n]),n++;return t}class Ue{constructor(e){this._config=e,this._pollingInterval=e.defaultInterval}_pollingTimers=new Map;_pollingInterval;_failedAttempts=0;_lastSuccessfulFetch=0;start(e){e&&this._pollingTimers.has(e)?this.stop(e):!e&&this._pollingTimers.has("global")&&this.stop("global"),this.refresh(e);const t=setInterval((()=>{this.refresh(e)}),this._pollingInterval);e?this._pollingTimers.set(e,t):this._pollingTimers.set("global",t)}stop(e){if(e){const t=this._pollingTimers.get(e);t&&(clearInterval(t),this._pollingTimers.delete(e))}else for(const[t,s]of this._pollingTimers.entries())clearInterval(s),this._pollingTimers.delete(t)}async refresh(e){try{const t=await this._config.refreshFn(e);return this._failedAttempts=0,this._lastSuccessfulFetch=Date.now(),this._pollingInterval=this._config.defaultInterval,this._config.stopCondition&&e&&this._config.stopCondition(t,e)&&this.stop(e),t}catch{return this._failedAttempts++,this._failedAttempts>3?this._pollingInterval=1e4:this._pollingInterval=Math.min(1e3*Math.pow(2,this._failedAttempts),1e4),null}}isPolling(e){return e?this._pollingTimers.has(e):this._pollingTimers.size>0}get timeSinceLastSuccessfulFetch(){return Date.now()-this._lastSuccessfulFetch}get failedAttempts(){return this._failedAttempts}resetFailedAttempts(){this._failedAttempts=0}}class He{constructor(e,t){this._enableBackgroundAgents=e,this._remoteAgentsClient=t,this._enableBackgroundAgentsFlag=!1,this._logsPollingManager=new Ue({defaultInterval:1e3,refreshFn:async s=>{if(!s)throw new Error("Agent ID is required for logs polling");return this.refreshAgentLogs(s)},stopCondition:(s,n)=>{if(!n)return!0;if(!this._state.agentOverviews.find((a=>a.remote_agent_id===n)))return this._state.logPollFailedCount++,this._state.logPollFailedCount>this._loggingMaxRetries&&(this._state.logPollFailedCount=0,!0);const r=this.state.agentLogs.get(n),i=r?.steps.at(-1);return i?.step_description.toLowerCase()==="setup script"&&(i.status===I.success||i.status===I.failure||i.status===I.skipped)}}),this._enableBackgroundAgents.subscribe((s=>{this._enableBackgroundAgentsFlag=s;const n=this._remoteAgentsClient.hasActiveOverviewsStream()||this._remoteAgentsClient.activeHistoryStreams.size>0||this._logsPollingManager.isPolling();s&&!n?this.startStateUpdates(this._pendingStateUpdateOpts):!s&&n&&this.stopStateUpdates()}))}_state={agentOverviews:[],agentConversations:new Map,agentLogs:new Map,maxRemoteAgents:0,maxActiveRemoteAgents:0,overviewError:void 0,conversationError:void 0,logsError:void 0,isOverviewsLoading:!1,isConversationLoading:!1,isLogsLoading:!1,logPollFailedCount:0};_loggingMaxRetries=8;_logsPollingManager;_isInitialOverviewFetch=!0;_lastOverviewUpdateTimestamp;_stateUpdateSubscribers=new Set;_enableBackgroundAgentsFlag;_pendingStateUpdateOpts;get state(){return this._state}startStateUpdates(e){if(!this._enableBackgroundAgentsFlag)return this._pendingStateUpdateOpts={...this._pendingStateUpdateOpts,...e},void(e||(this._pendingStateUpdateOpts.overviews=!0));e?(e.overviews&&this.startOverviewsStream(),e.conversation?.agentId&&this.startConversationStream(e.conversation.agentId),e.logs?.agentId&&(this._state.logPollFailedCount=0,this._logsPollingManager.start(e.logs.agentId))):this.startOverviewsStream()}_removePendingStateUpdates(e){this._pendingStateUpdateOpts&&(e?(e.overviews&&(this._pendingStateUpdateOpts.overviews=!1),e.conversation?.agentId===this._pendingStateUpdateOpts.conversation?.agentId&&(this._pendingStateUpdateOpts.conversation=void 0),e.logs?.agentId===this._pendingStateUpdateOpts.logs?.agentId&&(this._pendingStateUpdateOpts.logs=void 0)):this._pendingStateUpdateOpts=void 0)}stopStateUpdates(e){if(this._removePendingStateUpdates(e),!e)return this.stopOverviewsStream(),this._logsPollingManager.stop(),void this.stopAllConversationStreams();e.overviews&&this.stopOverviewsStream(),e.conversation?.agentId&&this.stopConversationStream(e.conversation.agentId),e.logs?.agentId&&this._logsPollingManager.stop(e.logs.agentId)}async refreshCurrentAgent(e){this.startConversationStream(e)}async refreshAgentOverviews(){return this.startOverviewsStream(),this._state.agentOverviews}async refreshAgentLogs(e){try{const t=this.state.agentLogs.get(e);let s,n;const r=t?.steps.at(-1);r?(s=r.step_number,n=r.step_number===0?0:r.sequence_id+1):(s=0,n=0);const i=await this._remoteAgentsClient.getRemoteAgentWorkspaceLogs(e,s,n);if(!i.data.workspaceSetupStatus)return;const a=i.data.workspaceSetupStatus;if(a.steps.length===0)return t;const g=(function(h,c){return{steps:[...h.steps,...c.steps].sort(((l,b)=>l.step_number!==b.step_number?l.step_number-b.step_number:l.sequence_id-b.sequence_id))}})(t??{steps:[]},a),o={steps:g.steps.reduce(((h,c)=>{const l=h[h.length-1];return l&&l.step_number===c.step_number?(l.status!==I.success&&(l.status=c.status),l.step_number===0?l.logs=c.logs:l.sequence_id<c.sequence_id&&(l.logs+=`
${c.logs}`,l.sequence_id=c.sequence_id)):h.push(c),h}),[])};return this._state.agentLogs.set(e,o),this._state.logsError=void 0,this.notifySubscribers({type:"logs",agentId:e,data:o}),o}catch(t){const s=t instanceof Error?t.message:String(t);return this._state.logsError={errorMessage:s},this.notifySubscribers({type:"logs",agentId:e,data:this._state.agentLogs.get(e)||{steps:[]},error:this._state.logsError}),this._state.agentLogs.get(e)}}onStateUpdate(e){return this._stateUpdateSubscribers.add(e),e({type:"all",data:this._state}),()=>{this._stateUpdateSubscribers.delete(e)}}dispose(){this.stopStateUpdates(),this._stateUpdateSubscribers.clear()}notifySubscribers(e){this._stateUpdateSubscribers.forEach((t=>t(e)))}async startConversationStream(e){this._remoteAgentsClient.hasActiveHistoryStream(e)&&this.stopConversationStream(e);const t=this._state.agentConversations.get(e)||[];let s=0;t.length>0&&(s=Math.max(...t.filter((n=>n.sequence_id!==void 0)).map((n=>n.sequence_id||0)))-1,s<0&&(s=0)),this._state.isConversationLoading=!0,this._state.conversationError=void 0,this.notifySubscribers({type:"conversation",agentId:e,data:t,error:this._state.conversationError});try{const n=this._remoteAgentsClient.startRemoteAgentHistoryStreamWithRetry(e,s);(async()=>{try{for await(const r of n){if(!this._remoteAgentsClient.hasActiveHistoryStream(e)||this._remoteAgentsClient.getActiveHistoryStream(e)?.isCancelled)break;this.processHistoryStreamUpdate(e,r)}}catch(r){if(this._remoteAgentsClient.hasActiveHistoryStream(e)){let i;r instanceof O?(i=`Failed to connect: ${r.message}`,console.error(`Stream retry exhausted for agent ${e}: ${r.message}`)):(i=r instanceof Error?r.message:String(r),console.error(`Stream error for agent ${e}: ${i}`)),this._state.conversationError={errorMessage:i},this._state.isConversationLoading=!1;const a=this._state.agentConversations.get(e)||[];this.notifySubscribers({type:"conversation",agentId:e,data:a,error:this._state.conversationError})}}finally{this._state.isConversationLoading=!1}})()}catch(n){let r;r=n instanceof O?`Failed to connect: ${n.message}`:n instanceof Error?n.message:String(n),this._state.conversationError={errorMessage:r},this._state.isConversationLoading=!1,this.notifySubscribers({type:"conversation",agentId:e,data:t,error:this._state.conversationError})}}stopConversationStream(e){this._remoteAgentsClient.cancelRemoteAgentHistoryStream(e)}stopAllConversationStreams(){this._remoteAgentsClient.cancelAllRemoteAgentHistoryStreams()}processHistoryStreamUpdate(e,t){if(Te(t)){this._state.conversationError=void 0;for(const s of t.updates){const n=this._state.agentConversations.get(e)||[];switch(s.type){case T.AGENT_HISTORY_EXCHANGE:if(s.exchange){const r=ke(n,[s.exchange]);this._state.agentConversations.set(e,r)}break;case T.AGENT_HISTORY_EXCHANGE_UPDATE:if(s.exchange_update){const r=s.exchange_update.sequence_id,i=n.findIndex((a=>a.sequence_id===r));if(i>=0){const a=n[i],g=a.exchange?.response_text||"";a.exchange.response_text=g+s.exchange_update.appended_text;const o=s.exchange_update.appended_nodes;if(o&&o.length>0){const c=a.exchange.response_nodes??[];a.exchange.response_nodes=[...c,...o]}const h=s.exchange_update.appended_changed_files;if(h&&h.length>0){const c=a.changed_files??[];a.changed_files=[...c,...h]}}}break;case T.AGENT_HISTORY_AGENT_STATUS:if(s.agent){const r=this._state.agentOverviews.findIndex((i=>i.remote_agent_id===e));r>=0?this._state.agentOverviews[r]=s.agent:(this._state.agentOverviews.push(s.agent),this._state.agentOverviews=C(this._state.agentOverviews)),this.notifySubscribers({type:"overviews",data:this._state.agentOverviews,error:this._state.overviewError})}}}this._state.isConversationLoading=!1,this.notifySubscribers({type:"conversation",agentId:e,data:this._state.agentConversations.get(e)||[],error:this._state.conversationError})}else{this.state.conversationError=t;const s=this._state.agentConversations.get(e)||[];this.notifySubscribers({type:"conversation",agentId:e,data:s,error:this._state.conversationError})}}async startOverviewsStream(){if(this._state.isOverviewsLoading=!0,this._state.overviewError=void 0,this.notifySubscribers({type:"overviews",data:this._state.agentOverviews,error:this._state.overviewError}),!this._remoteAgentsClient.hasActiveOverviewsStream())try{const e=this._remoteAgentsClient.startRemoteAgentsListStreamWithRetry(this._lastOverviewUpdateTimestamp);(async()=>{try{for await(const t of e){if(!this._remoteAgentsClient.hasActiveOverviewsStream())break;this.processOverviewsStreamUpdate(t)}}catch(t){if(this._remoteAgentsClient.hasActiveOverviewsStream()){let s;t instanceof O?(s=`Failed to connect: ${t.message}`,console.error(`Overview stream retry exhausted: ${t.message}`)):(s=t instanceof Error?t.message:String(t),console.error(`Overview stream error: ${s}`)),this._state.overviewError={errorMessage:s},this._state.isOverviewsLoading=!1,this.notifySubscribers({type:"overviews",data:this._state.agentOverviews,error:this._state.overviewError})}}finally{this._state.isOverviewsLoading=!1}})()}catch(e){let t;t=e instanceof O?`Failed to connect: ${e.message}`:e instanceof Error?e.message:String(e),this._state.overviewError={errorMessage:t},this._state.isOverviewsLoading=!1,this.notifySubscribers({type:"overviews",data:this._state.agentOverviews,error:this._state.overviewError})}}stopOverviewsStream(){this._remoteAgentsClient.cancelRemoteAgentOverviewsStream()}processOverviewsStreamUpdate(e){if(!Pe(e))return this._state.overviewError=e,void this.notifySubscribers({type:"overviews",data:this._state.agentOverviews,error:this._state.overviewError});this._state.overviewError=void 0;for(const t of e.updates)switch(t.update_timestamp&&(this._lastOverviewUpdateTimestamp=t.update_timestamp),t.max_agents!==void 0&&(this._state.maxRemoteAgents=t.max_agents),t.max_active_agents!==void 0&&(this._state.maxActiveRemoteAgents=t.max_active_agents),t.type){case R.AGENT_LIST_ALL_AGENTS:t.all_agents&&(this._state.agentOverviews=C(t.all_agents));break;case R.AGENT_LIST_AGENT_ADDED:t.agent&&(this._state.agentOverviews.push(t.agent),this._state.agentOverviews=C(this._state.agentOverviews));break;case R.AGENT_LIST_AGENT_UPDATED:if(t.agent){const s=this._state.agentOverviews.findIndex((n=>n.remote_agent_id===t.agent.remote_agent_id));s>=0&&(this._state.agentOverviews[s]=t.agent,this._state.agentOverviews=C(this._state.agentOverviews))}break;case R.AGENT_LIST_AGENT_DELETED:t.deleted_agent_id&&(this._state.agentOverviews=this._state.agentOverviews.filter((s=>s.remote_agent_id!==t.deleted_agent_id)))}this._state.isOverviewsLoading=!1,this.notifySubscribers({type:"overviews",data:structuredClone(this._state.agentOverviews),error:this._state.overviewError})}}var v=(d=>(d.chatRequestFailed="chat_request_failed",d.messageTimeout="message_timeout",d.agentFailed="agent_failed",d))(v||{});const F="This agent is in a failed state and can no longer accept messages",Ye=!1;class qe{_state={isActive:!1,isPanelFocused:!1,currentAgentId:void 0,currentConversation:void 0,currentAgent:void 0,agentOverviews:[],chatConversations:[],localAgentConversations:[],isLoading:!1,isCurrentAgentDetailsLoading:!1,lastSuccessfulOverviewFetch:0,failedRefreshAttempts:0,maxRemoteAgents:0,maxActiveRemoteAgents:0,isDiffPanelOpen:!1,diffPanelAgentId:void 0,focusedFilePath:null,isCreatingAgent:!1,error:void 0,agentThreadsError:void 0,agentLogsError:void 0,agentChatHistoryError:void 0,remoteAgentCreationError:null,newAgentDraft:null,notificationSettings:{},pinnedAgents:{},setCurrentAgent:this.setCurrentAgent.bind(this),clearCurrentAgent:this.clearCurrentAgent.bind(this),sendMessage:this.sendMessage.bind(this),interruptAgent:this.interruptAgent.bind(this),createRemoteAgent:this.createRemoteAgent.bind(this),createRemoteAgentFromDraft:this.createRemoteAgentFromDraft.bind(this),deleteAgent:this.deleteAgent.bind(this),setNewAgentDraft:this.setNewAgentDraft.bind(this),setRemoteAgentCreationError:this.setRemoteAgentCreationError.bind(this),setGenerateSetupScriptSelected:this.setGenerateSetupScriptSelected.bind(this),hasFetchedOnce:!1,showRemoteAgentDiffPanel:this.showRemoteAgentDiffPanel.bind(this),closeRemoteAgentDiffPanel:this.closeRemoteAgentDiffPanel.bind(this),setIsCreatingAgent:this.setIsCreatingAgent.bind(this),toggleAgentPinned:this.toggleAgentPinned.bind(this),setPinnedAgents:this.setPinnedAgents.bind(this),pauseRemoteAgentWorkspace:this.pauseRemoteAgentWorkspace.bind(this),resumeRemoteAgentWorkspace:this.resumeRemoteAgentWorkspace.bind(this),isRemoteAgentSshWindow:!1,remoteAgentSshWindowId:void 0,generateSetupScriptSelected:!1};_reduxStore;_agentConversations=new Map;_initialPrompts=new Map;_agentSetupLogsCache=new Map;_creationMetrics;_preloadedDiffExplanations=new Map;subscribers=new Set;agentSetupLogs=void 0;static key="remoteAgentsModel";_remoteAgentsClient;_stateModel;_extensionClient;_enableBackgroundAgents;_gitRefModel;_cachedUrls=new Map;_pendingMessageTracking=new Map;_agentSendMessageErrors=new Map;sendMessageTimeoutMs=9e4;_hasEverUsedRemoteAgent=ce(void 0);constructor({reduxStore:e,msgBroker:t,isActive:s,extensionClientConfig:n,enableBackgroundAgents:r,host:i,gitRefModel:a,stateModel:g}){this._reduxStore=e,this._state.isActive=s,this._enableBackgroundAgents=r,this._gitRefModel=a,this._remoteAgentsClient=new Fe(t),this._extensionClient=new Ce(i,t,n),this._stateModel=g||new He(this._enableBackgroundAgents,this._remoteAgentsClient),this._stateModel.onStateUpdate(this.handleStateUpdate.bind(this)),this._enableBackgroundAgents.subscribe((o=>{o?this._stateModel.startStateUpdates():(this.setIsActive(!1),this._stateModel.stopStateUpdates())})),this.loadPinnedAgentsFromStore(),this.refreshHasEverUsedRemoteAgent(),this.checkRemoteAgentStatus()}async checkRemoteAgentStatus(){const e=await this._remoteAgentsClient.getRemoteAgentStatus();this._state.isRemoteAgentSshWindow=e.data.isRemoteAgentSshWindow,this._state.remoteAgentSshWindowId=e.data.remoteAgentId,this.notifySubscribers()}handleOverviewsUpdate(e){const t=e.data,s=this._state.agentOverviews,n=t;if(this.isActive&&n.forEach((i=>{i.remote_agent_id===this._state.currentAgentId&&(i.has_updates=!1)})),this._state.currentAgentId&&(this._state.currentAgent=this._state.agentOverviews.find((i=>i.remote_agent_id===this._state.currentAgentId))),this._state.currentAgentId){const i=this._state.currentAgentId,a=i?s.find((o=>o.remote_agent_id===i))?.status:void 0,g=i?n.find((o=>o.remote_agent_id===i))?.status:void 0;if(g!==a)if(g===_.agentFailed){const o={type:v.agentFailed,errorMessage:F,canRetry:!1};this._agentSendMessageErrors.set(i,o)}else this._agentSendMessageErrors.delete(i)}this.maybeSendNotifications(n,s);const r=C(n);this._state.agentOverviews=r,this._state.hasFetchedOnce=!0,this._state.agentThreadsError=e.error,this._state.lastSuccessfulOverviewFetch=e.error?this._state.lastSuccessfulOverviewFetch:Date.now(),r.findIndex((i=>i.remote_agent_id===this._state.currentAgentId))===-1&&this.clearCurrentAgent()}handleConversationUpdate(e){if(e.agentId===this._state.currentAgentId){const t={exchanges:e.data,lastFetched:new Date};this._agentConversations.set(e.agentId,t),this._state.currentConversation=t,this._state.agentChatHistoryError=e.error;const s=this._agentSendMessageErrors.get(e.agentId);if(s?.failedExchangeId){const n=s.failedExchangeId;this._state.currentConversation?.exchanges.some((i=>i.exchange.request_id===n))||this._agentSendMessageErrors.delete(e.agentId)}this._state.isCurrentAgentDetailsLoading=!1}}handleLogsUpdate(e){const t=structuredClone(e.data);e.agentId===this._state.currentAgentId&&(this.agentSetupLogs=t,this._agentSetupLogsCache.set(e.agentId,t))}handleStateUpdate(e){switch(this._state.maxRemoteAgents=this._stateModel.state.maxRemoteAgents,this._state.maxActiveRemoteAgents=this._stateModel.state.maxActiveRemoteAgents,e.type){case"overviews":this.handleOverviewsUpdate(e);break;case"conversation":this.handleConversationUpdate(e);break;case"logs":this.handleLogsUpdate(e);break;case"all":this.handleOverviewsUpdate({type:"overviews",data:e.data.agentOverviews,error:e.data.overviewError}),e.data.agentConversations.forEach(((t,s)=>{this._agentConversations.set(s,{exchanges:t,lastFetched:new Date})})),structuredClone(e.data.agentLogs).forEach(((t,s)=>{t&&(this._agentSetupLogsCache.set(s,t),s===this._state.currentAgentId&&(this.agentSetupLogs=t))})),this._state.hasFetchedOnce=!0,this._state.agentThreadsError=e.data.overviewError,this._state.agentChatHistoryError=e.data.conversationError,this._state.agentLogsError=e.data.logsError;break}this.currentAgentId&&this.checkForHistoryErrors(this.currentAgentId),this.notifySubscribers()}subscribe(e){return this.subscribers.add(e),e(this),()=>{this.subscribers.delete(e)}}notifySubscribers(){this.subscribers.forEach((e=>e(this)))}showRemoteAgentDiffPanel(e){const t=this._state.currentAgentId;if(this.reportRemoteAgentEvent({eventName:y.diffPanel,remoteAgentId:t??"",eventData:{diffPanelData:{applied:!1,loadingTimeMs:0}}}),t&&e.changedFiles.length>0&&e.turnIdx===-1&&e.isShowingAggregateChanges){const s=`${t}-${this.generateChangedFilesHash(e.changedFiles)}`,n=this._preloadedDiffExplanations.get(s);if(n)return n.lastAccessed=Date.now(),this._preloadedDiffExplanations.set(s,n),this._remoteAgentsClient.showRemoteAgentDiffPanel({...e,preloadedExplanation:n.explanation,remoteAgentId:t}),this._state.isDiffPanelOpen=!0,this._state.diffPanelAgentId=t,void this.notifySubscribers()}this._remoteAgentsClient.showRemoteAgentDiffPanel({...e,remoteAgentId:t}),this._state.isDiffPanelOpen=!0,this._state.diffPanelAgentId=t,this.notifySubscribers()}closeRemoteAgentDiffPanel(){this._remoteAgentsClient.closeRemoteAgentDiffPanel(),this._state.isDiffPanelOpen=!1,this._state.diffPanelAgentId=void 0,this.notifySubscribers()}_getChatHistory(e){const t=this._agentConversations.get(e);if(!t)return[];const s=this.isAgentRunning(e);return t.exchanges.map((({exchange:n},r)=>{const i=n.request_id.startsWith("pending-");return{seen_state:ye.seen,structured_request_nodes:n.request_nodes??[],status:i||r===t.exchanges.length-1&&s?z.sent:z.success,request_message:n.request_message,response_text:i?"":n.response_text,structured_output_nodes:n.response_nodes??[],request_id:n.request_id??`remote-agent-${r}`}}))}getCurrentChatHistory(){const e=this.agentSetupLogs;return this.currentAgentId&&!e&&(this.agentSetupLogs={steps:[]},this._stateModel.startStateUpdates({logs:{agentId:this.currentAgentId}})),this._getChatHistory(this.currentAgentId??"")}getToolStates(){return this.currentConversation?.exchanges?(function(e,t){const s=new Map,n=new Set,r=new Map;e.forEach((o=>{o.exchange.response_nodes?.forEach((h=>{h.tool_use&&n.add(h.tool_use.tool_use_id)})),o.exchange.request_nodes?.forEach((h=>{h.type===B.TOOL_RESULT&&h.tool_result_node&&r.set(h.tool_result_node.tool_use_id,h.tool_result_node)}))}));const i=e[e.length-1];let a=0,g=null;return i?.exchange.response_nodes?.forEach((o=>{o.id>a&&(a=o.id,g=o.tool_use?.tool_use_id?o.tool_use.tool_use_id:null)})),n.forEach((o=>{const h=r.get(o);if(h)s.set(o,{phase:h.is_error?m.error:m.completed,result:{isError:h.is_error,text:h.content},requestId:"",toolUseId:o});else{const c=t;o===g?s.set(o,{phase:c?m.running:m.cancelled,requestId:"",toolUseId:o}):s.set(o,{phase:m.cancelled,requestId:"",toolUseId:o})}})),s})(this.currentConversation?.exchanges,this.isCurrentAgentRunning):new Map}getLastToolUseState(){const e=this.getToolStates(),t=[...e.keys()].pop();return e.get(t??"")??{phase:m.unknown}}getToolUseState(e){const t=e;return this.getToolStates().get(t)??{phase:m.completed,requestId:"",toolUseId:e}}async setCurrentAgent(e){if(this._state.currentAgentId&&this._stateModel.stopStateUpdates({conversation:{agentId:this._state.currentAgentId},logs:{agentId:this._state.currentAgentId}}),this._state.currentAgentId=e,this._state.isCurrentAgentDetailsLoading=!!e,e&&this._agentSetupLogsCache.has(e)?this.agentSetupLogs=this._agentSetupLogsCache.get(e):this.agentSetupLogs=void 0,e&&this.checkForHistoryErrors(e),this.notifySubscribers(),e){this._stateModel.startStateUpdates({conversation:{agentId:e},logs:{agentId:e}});try{const t=this._state.agentOverviews.find((s=>s.remote_agent_id===e));!t||t.workspace_status!==P.workspacePaused&&t.workspace_status!==P.workspacePausing||await this._remoteAgentsClient.resumeHintRemoteAgent(e)}catch(t){console.warn("Failed to send resume hint to remote agent:",t)}}}clearCurrentAgent(){this._state.currentAgentId&&this._stateModel.stopStateUpdates({conversation:{agentId:this._state.currentAgentId},logs:{agentId:this._state.currentAgentId}}),this._state.currentAgentId=void 0,this.agentSetupLogs=void 0,this.notifySubscribers()}generateChangedFilesHash(e){const t=e.map((s=>({oldPath:s.old_path,newPath:s.new_path,oldSize:s.old_contents?.length||0,newSize:s.new_contents?.length||0,oldHash:this.simpleHash(s.old_contents||""),newHash:this.simpleHash(s.new_contents||"")})));return this.simpleHash(JSON.stringify(t))}simpleHash(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t.toString(36)}async sendMessage(e,t){const s=this._state.currentAgentId;if(!s)return this._state.error="No active remote agent",this.notifySubscribers(),!1;if(this._state.agentOverviews.find((i=>i.remote_agent_id===s))?.status===_.agentFailed){const i={type:v.agentFailed,errorMessage:F,canRetry:!1};return this._agentSendMessageErrors.set(s,i),this.notifySubscribers(),!1}let r;this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{const i=this._agentConversations.get(s)||{exchanges:[],lastFetched:new Date},a=(this.getfinalSequenceId(s)||0)+1;r="pending-"+Date.now();const g={exchange:{request_message:e,response_text:"",request_id:r,response_nodes:[],request_nodes:[]},changed_files:[],sequence_id:a};i.exchanges.push(g),this._agentConversations.set(s,i),this._state.currentConversation=i,this.notifySubscribers(),this.setupMessageTimeout(s,r);const o={request_nodes:[{id:1,type:B.TEXT,text_node:{content:e}}],model_id:t},h=await this._remoteAgentsClient.sendRemoteAgentChatRequest(s,o,this.sendMessageTimeoutMs);if(h.data.error)throw new Error(h.data.error);return this.clearMessageTimeout(s,r),!0}catch(i){r&&this.clearMessageTimeout(s,r);const a={type:v.chatRequestFailed,errorMessage:`There was an error sending your message. Please try again. Agent ID: ${s}. ${i}`,canRetry:!0,failedExchangeId:r};return this._agentSendMessageErrors.set(s,a),console.error("Failed to send message:",i),this.notifySubscribers(),!1}finally{this._state.isLoading=!1,this.notifySubscribers()}}setupMessageTimeout(e,t){const s=setTimeout((()=>{this.handleMessageTimeout(e,t)}),this.sendMessageTimeoutMs);this._pendingMessageTracking.has(e)||this._pendingMessageTracking.set(e,new Map),this._pendingMessageTracking.get(e).set(t,{timeout:s,timestamp:Date.now()})}clearMessageTimeout(e,t){const s=this._pendingMessageTracking.get(e);if(s){const n=s.get(t);n&&(clearTimeout(n.timeout),s.delete(t),s.size===0&&this._pendingMessageTracking.delete(e))}}async handleMessageTimeout(e,t){const s=this._pendingMessageTracking.get(e);if(s&&(s.delete(t),s.size===0&&this._pendingMessageTracking.delete(e)),this._state.agentOverviews.find((a=>a.remote_agent_id===e))?.status===_.agentRunning)return;const r=this._agentConversations.get(e);if(!r||!r.exchanges.find((a=>a.exchange.request_id===t)))return;const i={type:v.messageTimeout,errorMessage:`There was an error sending your message. Please try again. Agent ID: ${e}`,canRetry:!0,failedExchangeId:t};this._agentSendMessageErrors.set(e,i);try{await this._remoteAgentsClient.interruptRemoteAgent(e)}catch(a){console.error("Failed to interrupt agent after timeout:",a)}this.notifySubscribers()}removeOptimisticExchange(e,t){const s=this._agentConversations.get(e);s&&(s.exchanges=s.exchanges.filter((n=>n.exchange.request_id!==t)),this._agentConversations.set(e,s),e===this._state.currentAgentId&&(this._state.currentConversation=s))}async retryFailedMessage(e,t){const s=this._agentConversations.get(e);if(!s)return!1;const n=s.exchanges.find((r=>r.exchange.request_id===t));return!!n&&(this.removeOptimisticExchange(e,t),this._agentSendMessageErrors.delete(e),this.notifySubscribers(),this.sendMessage(n.exchange.request_message))}async interruptAgent(){const e=this._state.currentAgentId;if(!e)return this._state.error="No active remote agent",void this.notifySubscribers();this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{await this._remoteAgentsClient.interruptRemoteAgent(e)}catch(t){this._state.error=t instanceof Error?t.message:String(t)}finally{this._state.isLoading=!1,this.notifySubscribers()}}async createRemoteAgent(e,t,s,n,r){if(!e||!e.trim())return this._state.error="Cannot create a remote agent with an empty prompt",void this.notifySubscribers();this.agentSetupLogs=void 0,this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{const i=await this._remoteAgentsClient.createRemoteAgent(e,t,s,n,r,this._creationMetrics);if(i.data.error)throw new Error(i.data.error);if(i.data.agentId&&i.data.success)return this._initialPrompts.set(i.data.agentId,e),await this.setNotificationEnabled(i.data.agentId,this.newAgentDraft?.enableNotification??!0),await this.setCurrentAgent(i.data.agentId),i.data.agentId;throw new Error("Failed to create remote agent: No agent ID returned")}catch(i){throw this._state.error=i instanceof Error?i.message:String(i),this.notifySubscribers(),i}finally{this._state.isLoading=!1,this.notifySubscribers()}}async createRemoteAgentFromDraft(e,t){if(this.setRemoteAgentCreationError(null),this.agentSetupLogs=void 0,!e||!e.trim())return void this.setRemoteAgentCreationError("Cannot create a remote agent with an empty prompt");const s=this._state.newAgentDraft;if(!s)return void this.setRemoteAgentCreationError("No workspace selected. Please select a workspace first.");if(s.isDisabled)return void this.setRemoteAgentCreationError("Cannot create agent with current workspace selection. Please resolve the issues with your workspace selection.");if(!s.commitRef||!s.selectedBranch)return void this.setRemoteAgentCreationError("No workspace selected. Please select a workspace first.");const n={starting_files:s.commitRef};this._state.isLoading=!0,this.notifySubscribers();try{const r=s.isSetupScriptAgent||s.setupScript?.isGenerateOption===!0;let i=r?void 0:s.setupScript?.content;if(s.setupScript&&!r){const a=(await this.listSetupScripts()).find((g=>g.path===s.setupScript.path));a&&(i=a.content)}try{return await this.createRemoteAgent(e,n,i,r,t)}catch(a){let g="Failed to create remote agent. Please try again.";return a instanceof Error&&(a.message.includes("too large")||a.message.includes("413")?g="Repository or selected files are too large. Please select a smaller repository or branch.":a.message.includes("timeout")||a.message.includes("504")?g="Request timed out. The repository might be too large or the server is busy.":a.message.includes("rate limit")||a.message.includes("429")?g="Rate limit exceeded. Please try again later.":a.message.includes("unauthorized")||a.message.includes("401")?g="Authentication failed. Please check your GitHub credentials.":a.message.includes("not found")||a.message.includes("404")?g="Repository or branch not found. Please check your selection.":a.message.includes("bad request")||a.message.includes("400")?g="Invalid request. Please check your workspace setup and try again.":a.message.length>0&&(g=`Failed to create remote agent: ${a.message}`)),void this.setRemoteAgentCreationError(g)}}finally{this._state.isLoading=!1,this.notifySubscribers()}}async deleteAgent(e,t=!1){this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{if(!await this._remoteAgentsClient.deleteRemoteAgent(e,t))return this._state.error="Failed to delete remote agent",this.notifySubscribers(),!1;this._agentConversations.delete(e),this._agentSetupLogsCache.delete(e),this._state.agentOverviews=this._state.agentOverviews.filter((s=>s.remote_agent_id!==e)),this.removeNotificationEnabled(e),this._state.currentAgentId===e&&this.clearCurrentAgent()}catch(s){this._state.error=s instanceof Error?s.message:String(s)}finally{this._state.isLoading=!1,this.notifySubscribers()}return!this._state.error}async sshToRemoteAgent(e){this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{return e.workspace_status!==P.workspaceRunning&&(await this._remoteAgentsClient.resumeRemoteAgentWorkspace(e.remote_agent_id),await new Promise((t=>setTimeout(t,5e3)))),await this._remoteAgentsClient.sshToRemoteAgent(e.remote_agent_id)}catch(t){return this._state.error=t instanceof Error?t.message:String(t),this.notifySubscribers(),!1}finally{this._state.isLoading=!1,this.notifySubscribers()}}async maybeSendNotifications(e,t){const s=new Map(t.map((r=>[r.remote_agent_id,r]))),n=await this._remoteAgentsClient.getRemoteAgentNotificationEnabled(e.map((r=>r.remote_agent_id)));e.forEach((r=>{const i=s.get(r.remote_agent_id),a=n[r.remote_agent_id],g=i?.status===_.agentRunning,o=r.status===_.agentIdle||r.status===_.agentFailed,h=r.remote_agent_id!==this._state.currentAgentId,c=this._state.isPanelFocused;a&&g&&o&&(h||!c)&&this._remoteAgentsClient.notifyRemoteAgentReady(r)}))}async setNotificationEnabled(e,t){await this._remoteAgentsClient.setRemoteAgentNotificationEnabled(e,t),this._state={...this._state,notificationSettings:{...this._state.notificationSettings,[e]:t}},this.notifySubscribers()}async removeNotificationEnabled(e){await this._remoteAgentsClient.deleteRemoteAgentNotificationEnabled(e);const{[e]:t,...s}=this._state.notificationSettings;this._state={...this._state,notificationSettings:s},this.notifySubscribers()}get hasFetchedOnce(){return this._state.hasFetchedOnce}get focusedFilePath(){return this._state.focusedFilePath}setFocusedFilePath(e){this._state.focusedFilePath=e,this.notifySubscribers()}handleMessageFromExtension(e){switch(e.data.type){case E.diffViewFileFocus:return this.setFocusedFilePath(e.data.data.filePath.replace(/^\/+/,"")),!0;case E.showRemoteAgentDiffPanel:return this._state.isDiffPanelOpen=!0,!0;case E.closeRemoteAgentDiffPanel:return this._state.isDiffPanelOpen=!1,!0;case E.remoteAgentStatusChanged:{const t=e.data;return this._state.isRemoteAgentSshWindow=t.data.isRemoteAgentSshWindow,this._state.remoteAgentSshWindowId=t.data.remoteAgentId,this.notifySubscribers(),!0}default:return!1}}get currentAgentId(){return this._state.currentAgentId}get currentConversation(){return this._agentConversations.get(this._state.currentAgentId??"")??void 0}_getAgentExchanges(e){return this._agentConversations.get(e)?.exchanges||[]}get currentExchanges(){const e=this._state.currentAgentId;return e?this._getAgentExchanges(e):[]}get currentStatus(){const e=this._state.currentAgentId;return e&&this._state.agentOverviews.find((t=>t.remote_agent_id===e))?.status||_.agentIdle}get currentAgent(){const e=this._state.currentAgentId;return e?this._state.agentOverviews.find((t=>t.remote_agent_id===e)):void 0}get agentOverviews(){return this._state.agentOverviews}get isLoading(){return this._state.isLoading}get isCurrentAgentDetailsLoading(){return this._state.isCurrentAgentDetailsLoading}get lastSuccessfulOverviewFetch(){return this._state.lastSuccessfulOverviewFetch}get error(){return this._state.error}get agentThreadsError(){return this._state.agentThreadsError}get agentChatHistoryError(){return this._state.agentChatHistoryError}clearSendMessageError(){this._state.currentAgentId&&(this._agentSendMessageErrors.delete(this._state.currentAgentId),this.notifySubscribers())}get sendMessageError(){return this._agentSendMessageErrors.get(this._state.currentAgentId??"")??void 0}checkForHistoryErrors(e){const t=this._getAgentExchanges(e);if(this._state.agentOverviews.find((r=>r.remote_agent_id===e))?.status===_.agentFailed){const r={type:v.agentFailed,errorMessage:F,canRetry:!1};return this._agentSendMessageErrors.set(e,r),void this.notifySubscribers()}const s=t.length>0&&t[t.length-1].exchange.request_id.startsWith("pending-"),n=this._agentSendMessageErrors.get(e);if(s&&!n){const r=t[t.length-1].exchange.request_id,i=this._pendingMessageTracking.get(e),a=i?.get(r);if(a&&Date.now()-a.timestamp>this.sendMessageTimeoutMs){const g={type:v.messageTimeout,errorMessage:`There was an error sending your message. Please try again. Agent ID: ${e}`,canRetry:!0,failedExchangeId:r};this._agentSendMessageErrors.set(e,g),this.clearMessageTimeout(e,r),this.notifySubscribers()}}}isAgentRunning(e){const t=this._state.agentOverviews.find((a=>a.remote_agent_id===e)),s=!(!t||t.status!==_.agentRunning&&t.status!==_.agentStarting),n=this._getAgentExchanges(e),r=this._agentSendMessageErrors.get(e),i=n.length>0&&n[n.length-1].exchange.request_id.startsWith("pending-")&&!r;return s||i}get isCurrentAgentRunning(){return!!this._state.currentAgentId&&this.isAgentRunning(this._state.currentAgentId)}get maxRemoteAgents(){return this._state.maxRemoteAgents}get maxActiveRemoteAgents(){return this._state.maxActiveRemoteAgents}getInitialPrompt(e){return this._initialPrompts.get(e)}clearInitialPrompt(e){this._initialPrompts.delete(e)}get notificationSettings(){return this._state.notificationSettings}get pinnedAgents(){return this._state.pinnedAgents}getfinalSequenceId(e){const t=this._agentConversations.get(e),s=t?.exchanges;if(s)return s[s.length-1]?.sequence_id??void 0}async listSetupScripts(){try{return(await this._remoteAgentsClient.listSetupScripts()).data.scripts}catch(e){return this._state.error=e instanceof Error?e.message:String(e),this.notifySubscribers(),[]}}async saveSetupScript(e,t,s){try{const n=await this._remoteAgentsClient.saveSetupScript(e,t,s);return n.data.success||(this._state.error=n.data.error||"Failed to save setup script",this.notifySubscribers()),n.data}catch(n){return this._state.error=n instanceof Error?n.message:String(n),this.notifySubscribers(),{success:!1,error:n instanceof Error?n.message:String(n)}}}async deleteSetupScript(e,t){try{const s=await this._remoteAgentsClient.deleteSetupScript(e,t);return s.data.success||(this._state.error=s.data.error||"Failed to delete setup script",this.notifySubscribers()),s.data}catch(s){return this._state.error=s instanceof Error?s.message:String(s),this.notifySubscribers(),{success:!1,error:s instanceof Error?s.message:String(s)}}}async renameSetupScript(e,t,s){try{const n=await this._remoteAgentsClient.renameSetupScript(e,t,s);return n.data.success||(this._state.error=n.data.error||"Failed to rename setup script",this.notifySubscribers()),n.data}catch(n){return this._state.error=n instanceof Error?n.message:String(n),this.notifySubscribers(),{success:!1,error:n instanceof Error?n.message:String(n)}}}get isActive(){return Ee.select(this._reduxStore.getState())}setIsActive(e){this._state.isActive=e;const t=this._state.currentAgentId,s={conversation:t?{agentId:t}:void 0,logs:t?{agentId:t}:void 0};e?(this._stateModel.startStateUpdates(s),this._reduxStore.dispatch(X(!0))):(this._stateModel.stopStateUpdates(s),this._reduxStore.dispatch(X(!1))),this.notifySubscribers()}get isPanelFocused(){return this._state.isPanelFocused}setIsPanelFocused(e){this._state.isPanelFocused=e,this.notifySubscribers()}optimisticallyClearAgentUpdates(e){const t=this._state.agentOverviews.findIndex((s=>s.remote_agent_id===e));if(t!==-1&&this._state.agentOverviews[t].has_updates){const s=[...this._state.agentOverviews];s[t]={...s[t],has_updates:!1},this._state.agentOverviews=s,this._state.currentAgent?.remote_agent_id===e&&(this._state.currentAgent={...this._state.currentAgent,has_updates:!1}),this.notifySubscribers()}}async updateRemoteAgentTitle(e,t){const s=this._state.agentOverviews.findIndex((r=>r.remote_agent_id===e));if(s===-1)return void console.warn(`Agent with ID ${e} not found in overviews`);const n=this._state.agentOverviews[s].title;try{const r=[...this._state.agentOverviews];r[s]={...r[s],title:t},this._state.agentOverviews=r,this._state.currentAgent?.remote_agent_id===e&&(this._state.currentAgent={...this._state.currentAgent,title:t}),this.notifySubscribers();const i=await this._remoteAgentsClient.updateRemoteAgentTitle(e,t);if(!i.data.success||!i.data.agent)throw console.error("Failed to update remote agent title:",i.data.error),this._state.error=i.data.error||"Failed to update remote agent title",new Error(this._state.error);{const a=[...this._state.agentOverviews];a[s]=i.data.agent,this._state.agentOverviews=a,this._state.currentAgent?.remote_agent_id===e&&(this._state.currentAgent=i.data.agent),this.notifySubscribers()}}catch(r){const i=[...this._state.agentOverviews];i[s]={...i[s],title:n},this._state.agentOverviews=i,this._state.currentAgent?.remote_agent_id===e&&(this._state.currentAgent={...this._state.currentAgent,title:n});const a=r instanceof Error?r.message:String(r);throw this._state.error=a,this.notifySubscribers(),r}}setRemoteAgentCreationError(e){this._state.remoteAgentCreationError=e,this.notifySubscribers()}get isDiffPanelOpen(){return this._state.isDiffPanelOpen}get diffPanelAgentId(){return this._state.diffPanelAgentId}get remoteAgentCreationError(){return this._state.remoteAgentCreationError}setNewAgentDraft(e){this._state.newAgentDraft=e,this.notifySubscribers()}get generateSetupScriptSelected(){return this._state.generateSetupScriptSelected}setGenerateSetupScriptSelected(e){this._state.generateSetupScriptSelected=e,this.notifySubscribers()}setCreationMetrics(e){this._creationMetrics=e}get creationMetrics(){return this._creationMetrics}refreshAgentChatHistory(e){this._stateModel.refreshCurrentAgent(e)}get newAgentDraft(){return this._state.newAgentDraft}dispose=()=>{this._stateModel.dispose(),this._remoteAgentsClient.dispose(),this._agentConversations.clear(),this._agentSetupLogsCache.clear(),this._preloadedDiffExplanations.clear(),this._cachedUrls.clear(),this._pendingMessageTracking.forEach((e=>{e.forEach((t=>clearTimeout(t.timeout)))})),this._pendingMessageTracking.clear(),this._agentSendMessageErrors.clear(),this.subscribers.clear()};setIsCreatingAgent(e){this._state.isCreatingAgent=e,this.notifySubscribers()}get isCreatingAgent(){return this._state.isCreatingAgent}get isRemoteAgentSshWindow(){return this._state.isRemoteAgentSshWindow}get remoteAgentSshWindowId(){return this._state.remoteAgentSshWindowId}async showRemoteAgentHomePanel(){await this._remoteAgentsClient.showRemoteAgentHomePanel()}async closeRemoteAgentHomePanel(){await this._remoteAgentsClient.closeRemoteAgentHomePanel()}async saveLastRemoteAgentSetup(e,t,s){try{await this._remoteAgentsClient.saveLastRemoteAgentSetup(e,t,s)}catch(n){console.error("Failed to save last remote agent setup:",n)}}async getLastRemoteAgentSetup(){try{return(await this._remoteAgentsClient.getLastRemoteAgentSetup()).data}catch(e){return console.error("Failed to get last remote agent setup:",e),{lastRemoteAgentGitRepoUrl:null,lastRemoteAgentGitBranch:null,lastRemoteAgentSetupScript:null}}}async loadPinnedAgentsFromStore(){try{const e=await this._remoteAgentsClient.getPinnedAgentsFromStore();this._reduxStore.dispatch(Ie(e)),this._state.pinnedAgents=e,this.notifySubscribers()}catch(e){console.error("Failed to load pinned agents from store:",e)}}async toggleAgentPinned(e,t){if(!e)return this._state.pinnedAgents;const s=!(t=t??!1);try{this._reduxStore.dispatch(s?j(e):V(e)),s?await this._remoteAgentsClient.savePinnedAgentToStore(e,!0):await this._remoteAgentsClient.deletePinnedAgentFromStore(e);const n=await this._remoteAgentsClient.getPinnedAgentsFromStore();return this._state.pinnedAgents=n,this.notifySubscribers(),n}catch(n){return this._reduxStore.dispatch(t?j(e):V(e)),console.error("Failed to toggle pinned status for remote agent:",n),this._state.pinnedAgents}}async getConversationUrl(e){const t=this._cachedUrls.get(e),s=this._agentConversations.get(e),n=s?.exchanges.length??0;if(t&&s&&t[0]===n)return t[1];const r=this._getChatHistory(e).map((g=>({...g,request_id:g.request_id||"",request_message:g.request_message,response_text:g.response_text||""})));if(r.length===0)throw new Error("No chat history to share");const i=await this._extensionClient.saveChat(e,r,`Remote Agent ${e}`);if(!i.data)throw new Error("Failed to create URL");const a=i.data?.url;return a&&this._cachedUrls.set(e,[n,a]),a}async refreshAgentThreads(){this._state.agentThreadsError=void 0,this._state.isLoading=!0,this.notifySubscribers();try{await this._stateModel.refreshAgentOverviews()}catch(e){console.error("Failed to refresh agent threads:",e)}finally{this._state.isLoading=!1,this.notifySubscribers()}}async openDiffInBuffer(e,t,s){await this._remoteAgentsClient.openDiffInBuffer(e,t,s)}async getShouldShowSSHConfigPermissionPrompt(){return this._remoteAgentsClient.getShouldShowSSHConfigPermissionPrompt()}async setPermissionToWriteToSSHConfig(e){await this._remoteAgentsClient.setPermissionToWriteToSSHConfig(e)}async pauseRemoteAgentWorkspace(e){await this._remoteAgentsClient.pauseRemoteAgentWorkspace(e)}async resumeRemoteAgentWorkspace(e){await this._remoteAgentsClient.resumeRemoteAgentWorkspace(e)}async reportRemoteAgentEvent(e){await this._remoteAgentsClient.reportRemoteAgentEvent(e)}getSourceControlType(){return Re.unknownSourceControl}async reportChatModeEvent(e,t){try{await this.reportRemoteAgentEvent({eventName:y.modeSelector,remoteAgentId:"",eventData:{modeSelectorData:{action:e,mode:t,sourceControl:this.getSourceControlType()}}})}catch(s){console.error("Failed to report chat mode event:",s)}}getCurrentRepoHash(){const e=this._state.newAgentDraft?.commitRef?.github_commit_ref?.repository_url;return e?this.simpleHash(e):""}getCurrentBranchHash(){const e=this._state.newAgentDraft?.selectedBranch?.name;return e?this.simpleHash(e):""}getHasSetupScriptSelected(){return!!this._state.newAgentDraft?.setupScript}async getGithubRepoInfo(){try{let e=0,t=!0,s=1;for(;t;){const{repos:n,hasNextPage:r,nextPage:i}=await this._gitRefModel.listUserRepos(s);e+=n.length,t=r,s=i}return{numReposAvailable:e,githubIntegrationEnabled:await this._gitRefModel.isGithubAuthenticated()}}catch{return{numReposAvailable:0,githubIntegrationEnabled:!1}}}async reportRemoteAgentSetupWindowEvent(e){try{const{numReposAvailable:t,githubIntegrationEnabled:s}=await this.getGithubRepoInfo(),n={action:e,repoHash:this.getCurrentRepoHash(),branchHash:this.getCurrentBranchHash(),hasSetupScriptSelected:this.getHasSetupScriptSelected(),githubIntegrationEnabled:s,numReposAvailable:t,sourceControl:this.getSourceControlType()};await this.reportRemoteAgentEvent({eventName:y.remoteAgentSetupWindow,remoteAgentId:"",eventData:{remoteAgentSetupWindowData:n}})}catch(t){console.error("Failed to report remote agent setup window event:",t)}}async reportRemoteAgentThreadListEvent(e,t,s){try{const n={action:e,numAgentsInList:t,sourceControl:this.getSourceControlType()};await this.reportRemoteAgentEvent({eventName:y.remoteAgentThreadList,remoteAgentId:s||"",eventData:{remoteAgentThreadListData:n}})}catch(n){console.error("Failed to report remote agent thread list event:",n)}}async reportRemoteAgentNewThreadButtonEvent(e,t,s){try{const n={action:e,threadType:t,sourceControl:this.getSourceControlType()};await this.reportRemoteAgentEvent({eventName:y.remoteAgentNewThreadButton,remoteAgentId:s||"",eventData:{remoteAgentNewThreadButtonData:n}})}catch(n){console.error("Failed to report remote agent new thread button event:",n)}}setPinnedAgents(e){this._state.pinnedAgents={...e},this.notifySubscribers()}setHasEverUsedRemoteAgent=e=>{this._extensionClient.setHasEverUsedRemoteAgent(e),this._hasEverUsedRemoteAgent.set(e)};get hasEverUsedRemoteAgent(){return this._hasEverUsedRemoteAgent}refreshHasEverUsedRemoteAgent=async()=>{if(W(this.hasEverUsedRemoteAgent)!==void 0)return;const e=await this._extensionClient.checkHasEverUsedRemoteAgent();W(this.hasEverUsedRemoteAgent)===void 0&&this._hasEverUsedRemoteAgent.set(e)}}const Je={lineNumbers:"off",wrappingIndent:"same",contextmenu:!1,wordBasedSuggestions:"off",renderLineHighlight:"none",occurrencesHighlight:"off",selectionHighlight:!1,codeLens:!1,links:!1,hover:{enabled:!1},hideCursorInOverviewRuler:!0,renderWhitespace:"none",renderFinalNewline:"on",lineHeight:16.5,fontSize:11};var Ne=ve("<span><!></span>");function Ke(d,e){de(e,!0);const t=()=>me(K,"$remoteAgentsModel",s),[s,n]=pe();let r=u(e,"path",19,(()=>{})),i=u(e,"start",3,0),a=u(e,"stop",3,0),g=u(e,"codeSnippetToLocate",19,(()=>{})),o=u(e,"size",3,0),h=u(e,"color",3,"neutral"),c=u(e,"variant",3,"ghost-block"),l=u(e,"stickyColor",3,!1),b=u(e,"tooltip",19,(()=>({neutral:"Open File In Editor",success:"Opening file..."}))),L=u(e,"metric",19,(()=>{})),Y=u(e,"onOpenLocalFile",3,(async function(p){if(p?.stopPropagation?.(),p?.preventDefault?.(),L()&&D.reportWebviewClientEvent(L()),!!r())return await k(),"success"}));const J=Oe(),D=xe(),k=async()=>{const p=await D.resolvePath({rootPath:"",relPath:r()}),f={repoRoot:p?.repoRoot??"",pathName:p?.pathName??"",range:{start:Math.max(i(),0),stop:Math.max(a(),0)}};return g()&&(f.snippet=g()),J(Me(f))},K=le(qe.key),Q=w((()=>t()?.isRemoteAgentSshWindow)),Z=w((()=>!!t()?.isActive)),ee=w((()=>!S(Z)||S(Q)));var te={openFile:k},U=$(),se=G(U),ne=p=>{var f=Ne(),ie=Se(f);{const ae=x=>{{let H=w((()=>o()===.5?1:o()));Le(x,{name:"external-link",get size(){return S(H)}})}};let oe=w((()=>b()||void 0)),ge=w((()=>!e.children));De(ie,{get defaultColor(){return h()},get stickyColor(){return l()},get size(){return o()},get variant(){return c()},get tooltip(){return S(oe)},stateVariant:{success:"soft"},get onClick(){return Y()},get icon(){return S(ge)},iconLeft:ae,children:(x,H)=>{var q=$(),he=G(q);fe(he,(()=>e.children??Ae)),M(x,q)},$$slots:{iconLeft:!0,default:!0}})}we((()=>be(f,1,`c-open-file-button-container c-open-file-button__size--${o()??""}`,"svelte-jf5h4i"))),M(p,f)};ue(se,(p=>{S(ee)&&p(ne)})),M(d,U);var re=_e(te);return n(),re}export{Je as D,Ke as O,qe as R,Ye as S,v as a};
//# sourceMappingURL=OpenFileButton-gT822Pcb.js.map
