import{W as a,aj as h}from"./debounce-BNOmQ76Y.js";import{S as u,a as y}from"./types-M1pd3FSp.js";try{d=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},(g=new d.Error().stack)&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[g]="67eef761-6019-4efc-b179-e3b3f3cca53d",d._sentryDebugIdIdentifier="sentry-dbid-67eef761-6019-4efc-b179-e3b3f3cca53d")}catch{}var d,g;class p extends Error{constructor(e){super(e),this.name="StreamRetryExhaustedError"}}class l{constructor(e,t,s,r,n=5,i=4e3,o=2,c){this.agentId=e,this.lastProcessedValue=t,this.startStreamFn=s,this.cancelStreamFn=r,this.maxRetries=n,this.baseDelay=i,this.attemptErrorThreshold=o,this.unhandledErrorMessage=c,this.streamId=crypto.randomUUID()}_isCancelled=!1;_isExhausted=!1;streamId;get isCancelled(){return this._isCancelled}get isExhausted(){return this._isExhausted}async cancel(){this._isCancelled=!0,await this.cancelStreamFn(this.streamId)}async*getStream(){let e=0;for(;!this._isCancelled;)try{const t=this.startStreamFn(this.agentId,this.streamId,this.lastProcessedValue);for await(const s of t){if(this._isCancelled)return;e=0,yield s}return}catch(t){const s=t instanceof Error?t.message:String(t);if(s===u&&(this._isCancelled=!0),this._isCancelled)return;if(e++,e>this.maxRetries)throw this._isExhausted=!0,new p(`Failed after ${this.maxRetries} attempts: ${s}`);let r=this.baseDelay*2**(e-1);s===y?r=0:e>this.attemptErrorThreshold&&(yield{errorMessage:this.unhandledErrorMessage??s,retryAt:new Date(Date.now()+r)}),console.warn(`Retrying remote agent stream in ${r/1e3} seconds... (Attempt ${e} of ${this.maxRetries})`),await new Promise((n=>setTimeout(n,r)));continue}}}const v=m=>m!=null&&m.updates!==void 0;class R extends l{constructor(e,t,s,r,n=5,i=4e3){super(e,t,s,r,n,i,1,"There was an error connecting to the remote agent.")}}const _=m=>m!=null&&m.updates!==void 0;class S extends l{constructor(e,t,s,r=5,n=4e3){super("overviews",e,t,s,r,n,2,void 0)}}class f{_msgBroker;_activeRetryStreams=new Map;_activeOverviewsStream;static key="remoteAgentsClient";constructor(e){this._msgBroker=e}hasActiveHistoryStream(e){return this._activeRetryStreams.has(e)}getActiveHistoryStream(e){return this._activeRetryStreams.get(e)}get activeHistoryStreams(){return this._activeRetryStreams}hasActiveOverviewsStream(){return this._activeOverviewsStream!==void 0&&!this._activeOverviewsStream.isCancelled}getActiveOverviewsStream(){return this._activeOverviewsStream}async sshToRemoteAgent(e){const t=await this._msgBroker.send({type:a.remoteAgentSshRequest,data:{agentId:e}},1e4);return!!t.data.success||(console.error("Failed to connect to remote agent:",t.data.error),!1)}async deleteRemoteAgent(e,t=!1){return(await this._msgBroker.send({type:a.deleteRemoteAgentRequest,data:{agentId:e,doSkipConfirmation:t}},1e4)).data.success}showRemoteAgentHomePanel(){this._msgBroker.postMessage({type:a.showRemoteAgentHomePanel})}closeRemoteAgentHomePanel(){this._msgBroker.postMessage({type:a.closeRemoteAgentHomePanel})}async getRemoteAgentNotificationEnabled(e){return(await this._msgBroker.send({type:a.getRemoteAgentNotificationEnabledRequest,data:{agentIds:e}},1e4)).data}async setRemoteAgentNotificationEnabled(e,t){await this._msgBroker.send({type:a.setRemoteAgentNotificationEnabled,data:{agentId:e,enabled:t}})}async deleteRemoteAgentNotificationEnabled(e){await this._msgBroker.send({type:a.deleteRemoteAgentNotificationEnabled,data:{agentId:e}})}async notifyRemoteAgentReady(e){await this._msgBroker.send({type:a.remoteAgentNotifyReady,data:e})}showRemoteAgentDiffPanel(e){this._msgBroker.postMessage({type:a.showRemoteAgentDiffPanel,data:e})}closeRemoteAgentDiffPanel(){this._msgBroker.postMessage({type:a.closeRemoteAgentDiffPanel})}async getRemoteAgentChatHistory(e,t,s=1e4){return await this._msgBroker.send({type:a.getRemoteAgentChatHistoryRequest,data:{agentId:e,lastProcessedSequenceId:t}},s)}async sendRemoteAgentChatRequest(e,t,s=9e4){return this._msgBroker.send({type:a.remoteAgentChatRequest,data:{agentId:e,requestDetails:t,timeoutMs:s}},s)}async interruptRemoteAgent(e,t=1e4){return await this._msgBroker.send({type:a.remoteAgentInterruptRequest,data:{agentId:e}},t)}async createRemoteAgent(e,t,s,r,n,i,o=1e4){return await this._msgBroker.send({type:a.createRemoteAgentRequest,data:{prompt:e,workspaceSetup:t,setupScript:s,isSetupScriptAgent:r,modelId:n,remoteAgentCreationMetrics:i}},o)}async getRemoteAgentOverviews(e=1e4){return await this._msgBroker.send({type:a.getRemoteAgentOverviewsRequest},e)}async listSetupScripts(e=5e3){return await this._msgBroker.send({type:a.listSetupScriptsRequest},e)}async saveSetupScript(e,t,s,r=5e3){return await this._msgBroker.send({type:a.saveSetupScriptRequest,data:{name:e,content:t,location:s}},r)}async deleteSetupScript(e,t,s=5e3){return await this._msgBroker.send({type:a.deleteSetupScriptRequest,data:{name:e,location:t}},s)}async renameSetupScript(e,t,s,r=5e3){return await this._msgBroker.send({type:a.renameSetupScriptRequest,data:{oldName:e,newName:t,location:s}},r)}async getRemoteAgentWorkspaceLogs(e,t,s,r=1e4){return await this._msgBroker.send({type:a.remoteAgentWorkspaceLogsRequest,data:{agentId:e,lastProcessedStep:t,lastProcessedSequenceId:s}},r)}async saveLastRemoteAgentSetup(e,t,s){return await this._msgBroker.send({type:a.saveLastRemoteAgentSetupRequest,data:{lastRemoteAgentGitRepoUrl:e,lastRemoteAgentGitBranch:t,lastRemoteAgentSetupScript:s}})}async getLastRemoteAgentSetup(){return await this._msgBroker.send({type:a.getLastRemoteAgentSetupRequest})}async*startRemoteAgentOverviewsStream(e,t,s=6e4,r=3e5){const n={type:a.remoteAgentOverviewsStreamRequest,data:{streamId:e,lastUpdateTimestamp:t}},i=this._msgBroker.stream(n,s,r);for await(const o of i){if(o.data.error)throw new Error(o.data.error);yield o.data.response}}async*startRemoteAgentHistoryStream(e,t,s,r=6e4,n=3e5){const i={type:a.remoteAgentHistoryStreamRequest,data:{streamId:t,agentId:e,lastProcessedSequenceId:s}},o=this._msgBroker.stream(i,r,n);for await(const c of o)yield c.data}async*startRemoteAgentsListStreamWithRetry(e,t=5,s=4e3){const r=new S(e,((n,i,o)=>this.startRemoteAgentOverviewsStream(i,o)),(n=>this._closeRemoteAgentsStream(n)),t,s);this._activeOverviewsStream?.cancel(),this._activeOverviewsStream=r;try{yield*r.getStream()}finally{r.isCancelled||r.isExhausted||(this._activeOverviewsStream=void 0)}}async*startRemoteAgentHistoryStreamWithRetry(e,t,s=5,r=4e3){const n=new R(e,t,((i,o,c)=>this.startRemoteAgentHistoryStream(i,o,c)),(i=>this._closeRemoteAgentsStream(i)),s,r);this._activeRetryStreams.get(e)?.cancel(),this._activeRetryStreams.set(e,n);try{yield*n.getStream()}finally{n.isCancelled||this._activeRetryStreams.delete(e)}}cancelRemoteAgentOverviewsStream(){this._activeOverviewsStream&&(this._activeOverviewsStream.cancel(),this._activeOverviewsStream=void 0)}cancelRemoteAgentHistoryStream(e){const t=this._activeRetryStreams.get(e);t&&(t.cancel(),this._activeRetryStreams.delete(e))}async _closeRemoteAgentsStream(e){await this._msgBroker.send({type:a.cancelRemoteAgentsStreamRequest,data:{streamId:e}})}cancelAllRemoteAgentHistoryStreams(){this._activeRetryStreams.forEach((e=>{e.cancel()})),this._activeRetryStreams.clear()}dispose(){this.cancelRemoteAgentOverviewsStream(),this.cancelAllRemoteAgentHistoryStreams()}async getPinnedAgentsFromStore(){try{return(await this._msgBroker.send({type:a.getRemoteAgentPinnedStatusRequest,data:{}})).data}catch(e){return console.error("Failed to get pinned agents from store:",e),{}}}async savePinnedAgentToStore(e,t){try{await this._msgBroker.send({type:a.setRemoteAgentPinnedStatus,data:{agentId:e,isPinned:t}})}catch(s){console.error("Failed to save pinned agent to store:",s)}}async deletePinnedAgentFromStore(e){try{await this._msgBroker.send({type:a.deleteRemoteAgentPinnedStatus,data:{agentId:e}})}catch(t){console.error("Failed to delete pinned agent from store:",t)}}async openDiffInBuffer(e,t,s){return await this._msgBroker.send({type:a.openDiffInBuffer,data:{oldContents:e,newContents:t,filePath:s}})}async getShouldShowSSHConfigPermissionPrompt(){return(await this._msgBroker.send({type:a.getShouldShowSSHConfigPermissionPromptRequest})).data}async setPermissionToWriteToSSHConfig(e){await this._msgBroker.send({type:a.setPermissionToWriteToSSHConfig,data:e})}async pauseRemoteAgentWorkspace(e){return await this._msgBroker.send({type:a.remoteAgentPauseRequest,data:{agentId:e}},3e4)}async resumeRemoteAgentWorkspace(e){return await this._msgBroker.send({type:a.remoteAgentResumeRequest,data:{agentId:e}},9e4)}async resumeHintRemoteAgent(e,t=h.viewingAgent){return await this._msgBroker.send({type:a.remoteAgentResumeHintRequest,data:{agentId:e,hintReason:t}},1e4)}async updateRemoteAgentTitle(e,t,s=1e4){return await this._msgBroker.send({type:a.updateRemoteAgentRequest,data:{agentId:e,newTitle:t}},s)}async reportRemoteAgentEvent(e){await this._msgBroker.send({type:a.reportRemoteAgentEvent,data:e})}async getRemoteAgentStatus(){return await this._msgBroker.send({type:a.getRemoteAgentStatus})}async generateRemoteAgentSummary(e,t,s,r=3e4){return await this._msgBroker.send({type:a.remoteAgentGenerateSummaryRequest,data:{agentId:e,startSequenceId:t,endSequenceId:s}},r)}async focusAugmentPanel(){await this._msgBroker.send({type:a.showAugmentPanel})}}export{f as R,p as S,_ as a,v as i};
//# sourceMappingURL=remote-agents-client-DkZKHKJj.js.map
