import{h as u,r as v,i as $,U as z,V as O}from"./index-BgxrR1pb.js";import{e as T,C as n,D as A}from"./channels-CdsIN6g2.js";const j=v([]),L=$(()=>T.filter(t=>{const e=n[t];return e?e.requiresPermission?j.value.includes(t):!0:!1})),k="active_channel_id";function R(){const t=localStorage.getItem(k);return t&&n[t]&&n[t].enabled?t:A}const h=z({}),g=v(R());O(g,t=>{localStorage.setItem(k,t)});function N(t){return h[t]||(h[t]={accounts:[],loading:!1,totalCount:0,normalCount:0,filteredTotal:0,currentPage:1,currentPageSize:20,selectedIds:[],refreshingIds:new Set,filterStatus:"",filterPlanType:"",filterNsfw:""}),h[t]}const J=$(()=>L.value.map(t=>{const e=h[t],a=n[t];return{channelId:t,name:(a==null?void 0:a.name)||t,total:(e==null?void 0:e.totalCount)||0,normal:(e==null?void 0:e.normalCount)||0,abnormal:((e==null?void 0:e.totalCount)||0)-((e==null?void 0:e.normalCount)||0)}}).filter(t=>t.total>0));async function q(){for(const t of T)await U(t)}async function U(t){const e=n[t],a=N(t);if(e)try{const s=await u.get(`${e.apiBase}/stats`);if(s.data.code===403)return;s.data.code===0&&(a.totalCount=s.data.data.total||0,a.normalCount=s.data.data.normal||0)}catch{}}function i(t){const e=t||g.value;return N(e)}function H(){return n[g.value]||n[A]}function W(t,e){if(n[t]){g.value=t;const a=i(t);a.accounts.length===0&&!a.loading&&l(t,e)}}async function l(t,e){const a=t||g.value,s=n[a],r=i(a);if(s){r.loading=!0;try{const o={page:r.currentPage,pageSize:r.currentPageSize};r.filterStatus&&(o.status=r.filterStatus),a==="kiro"&&r.filterPlanType&&(o.plan_type=r.filterPlanType),a==="grok"&&r.filterPlanType&&(o.pool=r.filterPlanType),a==="grok"&&r.filterNsfw&&(o.nsfw=r.filterNsfw);const c=await u.get(`${s.apiBase}/list`,{params:o});c.data.code===0?(r.accounts=c.data.data.list||[],r.totalCount=c.data.data.totalCount??c.data.data.total??0,r.normalCount=c.data.data.normalCount??r.accounts.filter(f=>f.status==="normal").length,r.filteredTotal=c.data.data.total??r.totalCount):c.data.code!==403&&(e==null||e.error(c.data.message||c.data.msg||`获取 ${s.name} 账号列表失败`))}catch{}finally{r.loading=!1}}}async function G(t,e,a){const s=n[t];if(s)try{const r=await u.post(`${s.apiBase}/delete`,{id:e});r.data.code===0?(a.success("删除成功"),await l(t,a)):a.error(r.data.message||r.data.msg||"删除失败")}catch{a.error("系统错误")}}async function K(t,e,a){const s=n[t],r=i(t);if(!(!s||e.length===0))try{const o=await u.post(`${s.apiBase}/delete-batch`,{ids:e});o.data.code===0?(a.success(`已删除 ${o.data.data.deleted} 个账号`),r.selectedIds=[],await l(t,a)):a.error(o.data.message||o.data.msg||"删除失败")}catch{a.error("系统错误")}}async function V(t,e){const a=n[t];if(a)try{const s=await u.post(`${a.apiBase}/delete-abnormal`,{});s.data.code===0?(e.success(`已删除 ${s.data.data.deleted} 个非正常账号`),await l(t,e)):e.error(s.data.message||s.data.msg||"删除失败")}catch{e.error("系统错误")}}async function X(t,e){const a=n[t];if(a)try{const s=await u.post(`${a.apiBase}/recover-abnormal`,{});s.data.code===0?(e.success(`已恢复 ${s.data.data.recovered} 个异常账号`),await l(t,e)):e.error(s.data.message||s.data.msg||"恢复失败")}catch{e.error("系统错误")}}async function Y(t,e,a){const s=n[t],r=i(t);if(s){r.refreshingIds.add(e);try{const o=await u.post(`${s.apiBase}/refresh`,{id:e});o.data.code===0?(a.success("刷新成功"),await l(t,a)):a.error(o.data.message||o.data.msg||"刷新失败")}catch{a.error("系统错误")}finally{r.refreshingIds.delete(e)}}}async function M(t,e){const a=n[t],s=i(t);if(a)try{const r=await u.get(`${a.apiBase}/export`,{params:{page:s.currentPage,pageSize:s.currentPageSize}});if(r.data.code===0){const o=JSON.stringify(r.data.data,null,2),c=new Blob([o],{type:"application/json"}),f=URL.createObjectURL(c),p=document.createElement("a");p.href=f,p.download=`${t}_accounts_page${s.currentPage}.json`,p.click(),URL.revokeObjectURL(f),e.success("导出成功")}else e.error(r.data.message||r.data.msg||"导出失败")}catch{e.error("系统错误")}}function Q(t,e){navigator.clipboard.writeText(t),e.success("已复制到剪贴板")}async function Z(t,e,a,s,r){var b;const o=n[t];if(!o)return;const c=i(t),f={scope:a,page:c.currentPage,pageSize:c.currentPageSize};t==="kiro"?f.plan_type=e:t==="grok"&&(f.pool=e);const p=localStorage.getItem("auth_token"),m={"Content-Type":"application/json"};p&&(m["X-Auth-Token"]=p);const S=(b=(await fetch(`${o.apiBase}/batch-refresh-usage`,{method:"POST",headers:m,body:JSON.stringify(f)})).body)==null?void 0:b.getReader(),x=new TextDecoder;let w="";if(S)for(;;){const{done:B,value:_}=await S.read();if(B)break;w+=x.decode(_,{stream:!0});const P=w.split(`
`);w=P.pop()||"";let C="";for(const y of P)if(y.startsWith("event: "))C=y.slice(7);else if(y.startsWith("data: "))try{const d=JSON.parse(y.slice(6));C==="result"?s({current:d.index,total:d.total,success:d.success,failed:d.index-d.success,result:d.result}):C==="done"&&r.success(`批量刷新完成: 成功 ${d.success} 个, 失败 ${d.failed} 个`)}catch{}}await l(t,r)}function I(t,e,a){const s=i(t);s.currentPage=e,s.selectedIds=[],l(t,a)}function tt(t){const e=i(t);e.selectedIds.length===e.accounts.length?e.selectedIds=[]:e.selectedIds=e.accounts.map(a=>a.id)}function et(t,e){const a=i(t),s=a.selectedIds.indexOf(e);s>-1?a.selectedIds.splice(s,1):a.selectedIds.push(e)}function at(t,e,a){const s=i(t);s.filterStatus=e,s.currentPage=1,s.selectedIds=[],l(t,a)}async function st(t,e,a,s){const r=n[t];if(!r)return!1;try{const o=await u.post(`${r.apiBase}/update-proxy`,{id:e,proxy:a});return o.data.code===0?(s.success("代理更新成功"),await l(t,s),!0):(s.error(o.data.message||o.data.msg||"更新失败"),!1)}catch{return s.error("系统错误"),!1}}function rt(t,e,a){const s=i(t);s.filterPlanType=e,s.currentPage=1,s.selectedIds=[],l(t,a)}function ot(t,e,a){const s=i(t);s.filterNsfw=e,s.currentPage=1,s.selectedIds=[],l(t,a)}export{L as a,l as b,J as c,g as d,at as e,q as f,rt as g,ot as h,I as i,M as j,et as k,Q as l,G as m,Z as n,V as o,X as p,K as q,Y as r,W as s,tt as t,st as u,H as v,i as w};
